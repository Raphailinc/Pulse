{% extends 'base.html' %}
{% block title %}Лента · Pulse{% endblock %}
{% block content %}
<div class="card">
  <div class="search-bar">
    <form method="get" action="{{ url_for('app.all_posts') }}" style="flex:1; display:flex; gap:10px;">
      <input type="search" name="search" placeholder="Поиск по заголовку или содержанию" value="{{ search }}">
      <button class="btn">Искать</button>
    </form>
    {% if current_user.is_authenticated %}
      <a class="btn primary" href="{{ url_for('app.create_post') }}">Создать пост</a>
    {% endif %}
  </div>
</div>

<div class="feed" style="margin-top:14px;">
  {% for post in posts.items %}
    <div class="post-card card">
      {% if post.image %}
        <img src="{{ url_for('static', filename=post.image) }}" alt="" style="width:100%; border-radius:10px; border:1px solid var(--border); max-height:180px; object-fit:cover;">
      {% endif %}
      <div class="post-meta">
        <img class="avatar" src="{{ post.user.profile_image_url() }}" alt="{{ post.user.username }}">
        <div>
          <strong>{{ post.user.username }}</strong>
          <div class="muted">{{ post.date_posted.strftime('%d.%m.%Y %H:%M') }}</div>
        </div>
      </div>
      <p class="post-title">{{ post.title }}</p>
      <p class="muted">{{ post.content[:220] }}{% if post.content|length > 220 %}…{% endif %}</p>
      <div class="actions">
        <a class="btn" href="{{ url_for('app.view_post', post_id=post.id) }}">Открыть</a>
        {% if current_user.is_authenticated and current_user == post.user %}
          <a class="btn" href="{{ url_for('app.edit_post', post_id=post.id) }}">Редактировать</a>
          <form method="post" action="{{ url_for('app.delete_post', post_id=post.id) }}" onsubmit="return confirm('Удалить пост?')" style="display:inline;">
            <button class="btn danger" type="submit">Удалить</button>
          </form>
        {% endif %}
      </div>
    </div>
  {% else %}
    <p class="empty">Посты не найдены.</p>
  {% endfor %}
</div>

{% if posts.pages > 1 %}
  <div style="margin-top:16px; display:flex; gap:10px; align-items:center;">
    {% if posts.has_prev %}
      <a class="btn" href="{{ url_for('app.all_posts', page=posts.prev_num, search=search) }}">Назад</a>
    {% endif %}
    <span class="muted">Стр. {{ posts.page }} из {{ posts.pages }}</span>
    {% if posts.has_next %}
      <a class="btn" href="{{ url_for('app.all_posts', page=posts.next_num, search=search) }}">Вперёд</a>
    {% endif %}
  </div>
{% endif %}
{% endblock %}
